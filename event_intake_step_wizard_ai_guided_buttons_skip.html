<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AV‑AI Ops — Event Wizard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --ink:#e6edff; --muted:#a7b0c6; --line:#223057; --accent:#6ea8fe; --ok:#59d18c; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;color:var(--ink);background:linear-gradient(180deg,#0a0f1b,#0e1530)}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{margin:0;font-size:24px}
    .ai{display:flex;gap:8px;align-items:center}
    input[type="text"],input[type="email"],input[type="time"],input[type="date"],textarea{background:#0c1323;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;width:100%}
    textarea{min-height:90px}
    .btn{background:#152545;border:1px solid #2b3d66;color:var(--ink);border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:hover{border-color:#3c58a0}
    .btn.primary{background:#142851;border-color:#2b56a2}
    .btn.ghost{background:transparent;border-color:#2b3d66}
    .btn.bad{background:#3a1c1c;border-color:#6e2b2b}
    .btn.ok{background:#123524;border-color:#1e6b43}
    .choices{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .choice{border:1px solid #2b3d66;background:#0c1323;color:var(--ink);padding:10px 12px;border-radius:999px;cursor:pointer;position:relative}
    /* simple tooltip */
    .choice[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:50%;bottom:calc(100% + 8px);transform:translateX(-50%);background:#0c1426;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.35);width:260px;white-space:pre-wrap;pointer-events:none;z-index:30}
    .choice[data-tip]:hover::before{content:"";position:absolute;left:50%;bottom:100%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--line)}
    .choice.selected{outline:2px solid var(--accent)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0f1e;border:1px solid var(--line);border-radius:6px;padding:2px 6px;font-size:12px}
    .hr{height:1px;background:var(--line);margin:16px 0}

    .progress{height:6px;background:#0a0f1e;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#4f7cff,#7ab3ff)}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,8,20,.6);backdrop-filter:blur(3px)}
    .panel{max-width:820px;width:92%;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    table.summary{width:100%;border-collapse:collapse}
    table.summary th, table.summary td{border:1px solid var(--line);padding:8px 10px;text-align:left}
    table.summary th{background:#0c1426;color:var(--ink)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2b3d66;border-radius:999px;margin:2px}
    .toast{position:fixed;right:14px;bottom:14px;background:#0c1323;border:1px solid var(--line);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:all .25s}
    .toast.show{opacity:1;transform:translateY(0)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header card">
      <div>
        <h1>AV‑AI Ops — Event Wizard</h1>
        <div class="muted">Answer step‑by‑step.</div>
      </div>
      <div class="ai" style="flex:1">
        <div id="instr" class="muted" style="line-height:1.4">
          <strong>How to use:</strong> Begin by selecting <b>Event Type</b>. Hover any option to see what it includes. Use <b>Next</b> to continue or <b>Skip</b> to move on. Click <b>Review & Submit</b> to confirm, then <b>Edit</b> to adjust.
        </div>
        <!-- Keep prompt controls hidden for tests/backward‑compat -->
        <input id="aiPrompt" class="hidden" placeholder="Describe your event…" />
        <button class="btn primary hidden" id="aiAssist">✨ Assist</button>
      </div>
    </div>

    <div class="card" id="wizard">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div id="message" style="margin:12px 0 4px; font-weight:600"></div>
      <div id="body"></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn ghost" id="backBtn">◀ Back</button>
        <div class="row">
          <button class="btn" id="skipBtn">Skip</button>
          <button class="btn ok" id="nextBtn">Next ▶</button>
          <button class="btn primary" id="reviewBtn" style="display:none">Review & Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="panel">
      <h3 id="confirmTitle" style="margin-top:0">Confirm Event Details</h3>
      <p class="muted">Please review your selections before final submission. You can edit or submit below.</p>
      <div id="confirmHtml"></div>
      <!-- keep hidden JSON for tests/automation -->
      <pre id="confirmJson" class="hidden"></pre>
      <div class="row" style="justify-content:flex-end;margin-top:12px;gap:8px">
        <button class="btn ghost" id="editBtn" type="button">✏️ Edit</button>
        <button class="btn bad" id="cancelConfirm" type="button">Cancel</button>
        <button class="btn ok" id="finalSubmit" type="button">Submit & Continue</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // -------- Base Wizard Steps (dynamic steps will be inserted based on selections) --------
    const BASE_STEPS = [ /* Always starts with Event Type */
      { key:'type', label:'What type of event is this?', kind:'choice', required:true, options:['All‑Hands','QBR','Town Hall','Product Launch','Training','Other'], help:"Pick the closest match; choose 'Other' to type your own." },
      { key:'event_name', label:'What is the event name?', kind:'text', required:true, placeholder:'e.g., Q4 All‑Hands' },
      { key:'date', label:'What is the date for the event?', kind:'date', required:true, help:'For multi‑day events, select the first day and note others later.' },
      { key:'start', label:'What time is the event start time?', kind:'time', required:true },
      { key:'end', label:'What time is the event end time?', kind:'time', required:true },
      { key:'room', label:'Which room or venue?', kind:'text', required:true, placeholder:'e.g., SF‑Auditorium or ZEPHYR‑12A' },
      { key:'platform', label:'Which UC platform?', kind:'choice', required:true, options:['Zoom','Teams','Webex'] },
      { key:'poc_name', label:'POC full name', kind:'text', required:true, placeholder:'Jane Doe' },
      { key:'poc', label:'POC email', kind:'email', required:true, placeholder:'jane.doe@company.com' },
      { key:'options', label:'Production options', kind:'multi', options:[
        'Kick‑Off Only','Entire Meeting Support','Video Camera','Remote Presenters','Special Guests / Executives','Local Q&A (mic runners)','Remote Q&A','Recording','PPT / Presentation','Videos (provide download link)','Handheld Mics','Lapel Mics','Intro Music (with instructions)','Clicker / Slide Advancer','Registration','Live Stream','Backup Room','ASL / Interpretation'
      ] },
      { key:'attachments', label:'Upload any documents (general)', kind:'file', multiple:true, required:false },
      { key:'notes', label:'Any notes?', kind:'textarea', placeholder:'Walk‑in 15 min, CEO intro, panel (5), Q&A… Include multi‑day info here.' }
    ];

    // compute dynamic steps (guests, slides)
    function computeSteps(){
      const steps = [...BASE_STEPS];
      const hasGuests = (state.options||[]).includes('Special Guests / Executives');
      const hasRemotePresenters = (state.options||[]).includes('Remote Presenters');
      const wantsSlides = (state.options||[]).includes('PPT / Presentation');
      const wantsVideos = (state.options||[]).includes('Videos (provide download link)');

      if (hasGuests){ steps.splice(10,0,{ key:'guests', label:'Add special guests / executives (name & email)', kind:'list', required:false }); }
      if (hasRemotePresenters){ steps.splice(10,0,{ key:'remote_presenters', label:'Add remote presenters (name & email)', kind:'list', required:false }); }
      if (wantsSlides){ steps.splice(steps.length-2,0,{ key:'slides', label:'Upload presentation deck (optional)', kind:'file', multiple:false, required:false }); }
      if (wantsVideos){ steps.splice(steps.length-2,0,{ key:'video_files', label:'Upload video files (optional)', kind:'file', multiple:true, required:false }); }
      return steps;
    }

    const state = { intent:'Event.Intake' };
    let idx = 0;

    const $ = s=>document.querySelector(s);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };

    function render(){
      const steps = computeSteps();
      const step = steps[idx];
      $('#message').textContent = step.label;
      $('#bar').style.width = ((idx)/steps.length*100)+'%';
      $('#nextBtn').style.display = (idx < steps.length-1) ? 'inline-block' : 'none';
      $('#reviewBtn').style.display = (idx === steps.length-1) ? 'inline-block' : 'none';

      const body = $('#body');
      body.innerHTML = '';
      $('#skipBtn').style.display = 'inline-block';
      $('#backBtn').style.display = (idx>0) ? 'inline-block' : 'none';

      if (step.kind === 'choice'){
        const wrap = document.createElement('div'); wrap.className='choices';
        step.options.forEach(opt=>{
          const b=document.createElement('button'); b.type='button'; b.className='choice'; b.textContent=opt;
          b.setAttribute('data-tip', getTip(step.key, opt));
          b.onclick=()=>{
            if (opt==='Other' && step.key==='type'){
              const input = prompt('Enter event type');
              if (input) state[step.key]=input; else return;
            } else { state[step.key]=opt; }
            [...wrap.children].forEach(c=>c.classList.remove('selected')); b.classList.add('selected');
            if (step.key==='options'){ // re-evaluate dynamic steps on options change
              idx = Math.min(idx+1, computeSteps().length-1);
              render();
            }
          };
          wrap.appendChild(b);
        });
        body.appendChild(wrap);
      }

      if (step.kind === 'date'){
        const i=document.createElement('input'); i.type='date'; i.id=step.key; i.value = state[step.key]||''; i.onchange=()=>state[step.key]=i.value; body.appendChild(i);
        if (step.help) body.appendChild(help(step.help));
      }
      if (step.kind === 'time'){
        const i=document.createElement('input'); i.type='time'; i.value = state[step.key]||''; i.onchange=()=>state[step.key]=i.value; body.appendChild(i);
      }
      if (step.kind === 'text' || step.kind==='email'){
        const i=document.createElement('input'); i.type = step.kind==='email' ? 'email' : 'text'; i.placeholder = step.placeholder||''; i.value = state[step.key]||''; i.oninput=()=>state[step.key]=i.value; body.appendChild(i);
      }
      if (step.kind === 'textarea'){
        const t=document.createElement('textarea'); t.placeholder=step.placeholder||''; t.value=state[step.key]||''; t.oninput=()=>state[step.key]=t.value; body.appendChild(t);
      }
      if (step.kind === 'multi'){
        const wrap=document.createElement('div'); wrap.className='choices';
        (step.options||[]).forEach(opt=>{
          const b=document.createElement('button'); b.type='button'; b.className='choice'; b.textContent=opt; b.dataset.val=opt;
          b.setAttribute('data-tip', getTip(step.key, opt));
          b.onclick=()=>{ b.classList.toggle('selected'); const curr=new Set(state[step.key]||[]); if (curr.has(opt)) curr.delete(opt); else curr.add(opt); state[step.key]=[...curr]; };
          wrap.appendChild(b);
        });
        body.appendChild(wrap);
      }
      if (step.kind === 'file'){
        const i=document.createElement('input'); i.type='file'; if (step.multiple) i.multiple=true; i.onchange=(e)=>{ state[step.key] = Array.from(e.target.files||[]).map(f=>({name:f.name,size:f.size,type:f.type})); }; body.appendChild(i);
        const p = document.createElement('p'); p.className='muted'; p.textContent = 'Uploads are optional in this demo; files are listed and sent as metadata.'; body.appendChild(p);
      }
      if (step.kind === 'list'){
        const c=document.createElement('div');
        const addRow=(pref={})=>{
          const row=document.createElement('div'); row.className='row';
          const n=document.createElement('input'); n.type='text'; n.placeholder='Full name'; n.value=pref.name||'';
          const e=document.createElement('input'); e.type='email'; e.placeholder='email@company.com'; e.value=pref.email||'';
          row.appendChild(n); row.appendChild(e);
          c.appendChild(row);
        };
        (state[step.key]||[]).forEach(x=>addRow(x));
        const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.type='button'; addBtn.textContent='Add person'; addBtn.onclick=()=>addRow();
        body.appendChild(c); body.appendChild(addBtn);
        // collect on advance
        $('#nextBtn').onclick = ()=>{ const rows=[...c.querySelectorAll('.row')]; state[step.key]=rows.map(r=>({name:r.children[0].value.trim(), email:r.children[1].value.trim()})).filter(x=>x.name||x.email); advance(); };
        $('#skipBtn').onclick = ()=>{ advance(); };
        return; // prevent re-binding default skip below for list step
      }

      // default next/skip handlers
      $('#skipBtn').onclick = ()=>{ state[step.key] = state[step.key] || null; advance(); };
      $('#nextBtn').onclick = advance;

      function advance(){
        const stepsNow = computeSteps();
        const s = stepsNow[idx];
        if (s.required && (state[s.key]===undefined || state[s.key]==='' || state[s.key]===null)){
          toast('This step is required. Use Skip only if allowed.');
          return;
        }
        if (idx < stepsNow.length-1) { idx++; render(); } else { /* end */ }
      }
    }

    function help(text){ const p=document.createElement('p'); p.className='muted'; p.textContent=text; return p; }

    function review(){
      const payload = buildPayload();
      // Pretty HTML summary
      const html = `
        <table class="summary">
          <tr><th>Field</th><th>Value</th></tr>
          <tr><td>Event Name</td><td>${escapeHtml(payload.name)}</td></tr>
          <tr><td>Type</td><td>${escapeHtml(payload.type||'')}</td></tr>
          <tr><td>Date</td><td>${escapeHtml(payload.date||'')}</td></tr>
          <tr><td>Start</td><td>${escapeHtml(payload.time||'')}</td></tr>
          <tr><td>End</td><td>${escapeHtml(payload.end||'')}</td></tr>
          <tr><td>Room</td><td>${escapeHtml(payload.room||'')}</td></tr>
          <tr><td>Platform</td><td>${escapeHtml(payload.platform||'')}</td></tr>
          <tr><td>POC</td><td>${escapeHtml((payload.poc_name||'') + ' <'+(payload.poc||'')+'>')}</td></tr>
          <tr><td>Options</td><td>${(payload.production_opts||[]).map(x=>`<span class='pill'>${escapeHtml(x)}</span>`).join(' ')}</td></tr>
          ${renderPeopleRow('Guests/Execs', state.guests)}
          ${renderPeopleRow('Remote Presenters', state.remote_presenters)}
          ${renderFilesRow('Slides', state.slides)}
          ${renderFilesRow('Videos', state.video_files)}
          ${renderFilesRow('Attachments', state.attachments)}
          <tr><td>Notes</td><td>${escapeHtml(payload.notes||'')}</td></tr>
        </table>`;
      document.getElementById('confirmHtml').innerHTML = html;
      document.getElementById('confirmJson').textContent = JSON.stringify(payload, null, 2); // keep for tests
      document.getElementById('confirmModal').style.display='flex';
    }

    function renderPeopleRow(label, arr){
      if (!arr || !arr.length) return '';
      const v = arr.map(p=>`${escapeHtml(p.name||'')} &lt;${escapeHtml(p.email||'')}&gt;`).join('<br>');
      return `<tr><td>${escapeHtml(label)}</td><td>${v}</td></tr>`;
    }
    function renderFilesRow(label, arr){
      if (!arr || !arr.length) return '';
      const v = arr.map(f=>`${escapeHtml(f.name)} (${(f.size||0)} bytes)`).join('<br>');
      return `<tr><td>${escapeHtml(label)}</td><td>${v}</td></tr>`;
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // Tooltip content for event types and options
    function getTip(stepKey, value){
      const EVENT_TIPS = {
        'All‑Hands':'Company‑wide update with exec speakers and Q&A. Typically 45–90 minutes, large audience, recording recommended.',
        'QBR':'Quarterly Business Review with leadership and key metrics. Often includes slide decks and recording.',
        'Town Hall':'Open forum with leadership; live Q&A. May require moderation and live stream.',
        'Product Launch':'External or internal announcement; often needs streaming, recordings, and media playback.',
        'Training':'Instructor‑led session; may need breakout rooms, polls, and recordings.'
      };
      const OPTION_TIPS = {
        'Kick‑Off Only':'Producer joins to start the session, then hands off.',
        'Entire Meeting Support':'Producer stays for the full event to operate and troubleshoot.',
        'Video Camera':'On‑site camera for in‑room video capture.',
        'Remote Presenters':'Speakers joining remotely; we’ll collect names/emails and schedule tech checks.',
        'Special Guests / Executives':'VIP presence; we’ll gather names/emails and plan white‑glove support.',
        'Local Q&A (mic runners)':'In‑room Q&A with microphone runners.',
        'Remote Q&A':'Moderated Q&A from remote attendees.',
        'Recording':'Record the session and deliver links afterward.',
        'PPT / Presentation':'Slide deck to be shared; you can upload now or later.',
        'Videos (provide download link)':'We’ll play video files during the event; upload or provide links.',
        'Handheld Mics':'Handheld microphones on site.',
        'Lapel Mics':'Clip‑on lavalier microphones on site.',
        'Intro Music (with instructions)':'Music during walk‑in/out; provide track and timing notes.',
        'Clicker / Slide Advancer':'Wireless slide advancer requested.',
        'Registration':'Collect attendees via form; we can configure platform and close date.',
        'Live Stream':'Broadcast to a wider audience (internal/external).',
        'Backup Room':'Reserve a standby room in case of issues.',
        'ASL / Interpretation':'Sign‑language or language interpreters; coordinate in advance.'
      };
      if (stepKey==='type') return EVENT_TIPS[value]||'Choose the closest event template.';
      if (stepKey==='options') return OPTION_TIPS[value]||'';
      if (stepKey==='platform') return {'Zoom':'Best for webinars and large meetings.','Teams':'Great for internal collaboration.','Webex':'Enterprise meetings/webinars.'}[value]||'';
      return '';
    }

    function buildPayload(){
      return {
        intent: 'Event.Intake',
        name: state.event_name || inferName(state),
        type: state.type,
        date: state.date,
        time: state.start,
        end: state.end,
        room: state.room,
        platform: state.platform,
        poc_name: state.poc_name,
        poc: state.poc,
        production_opts: mapOptions(state.options),
        notes: state.notes||'',
        guests: state.guests||[],
        remote_presenters: state.remote_presenters||[],
        slides: state.slides||[],
        videos: state.video_files||[],
        attachments: state.attachments||[]
      };
    }

    function mapOptions(arr){
      const m = {
        'Kick‑Off Only':'kickoff_only','Entire Meeting Support':'entire_meeting_support','Video Camera':'video_camera','Remote Presenters':'remote_presenters','Special Guests / Executives':'special_guests_execs','Local Q&A (mic runners)':'local_qna_micrunners','Remote Q&A':'remote_qna','Recording':'record','PPT / Presentation':'ppt_presentation','Videos (provide download link)':'videos_dl','Handheld Mics':'handheld_mics','Lapel Mics':'lapel_mics','Intro Music (with instructions)':'intro_music','Clicker / Slide Advancer':'clicker','Registration':'registration','Live Stream':'livestream','Backup Room':'backup','ASL / Interpretation':'asl'
      };
      return (arr||[]).map(x=>m[x]||x).filter(Boolean);
    }

    function inferName(s){
      const base = (s.type||'Event');
      const date = s.date || '';
      return `${base}${date?(' '+date):''}`;
    }

    function finalSubmit(){
      const payload = JSON.parse(document.getElementById('confirmJson').textContent||'{}');
      const API_BASE = '';// relative to current origin
      const headers = {'Content-Type':'application/json'};
      (async ()=>{
        try {
          const createRes = await fetch(`${API_BASE}/api/snow/create-event`, { method:'POST', headers, body: JSON.stringify(payload) });
          const created = await createRes.json();
          if (!created?.ok) throw new Error(created?.error || 'ServiceNow create failed');
          if (created.slack) { await fetch(`${API_BASE}/api/slack/announce`, { method:'POST', headers, body: JSON.stringify(created.slack) }).catch(()=>null); }
          document.getElementById('confirmModal').style.display='none';
          const evtNum = created?.parent?.number || created?.parent?.sys_id || 'event';
          toast(`Submitted! Created ${evtNum} and posted to Slack.`);
        } catch (e) { console.error(e); toast('Submission failed — check server logs/credentials.'); }
      })();
    }

    // ---- AI Assist (heuristic; replace with LLM gateway as needed) ----
    function aiAssist(){
      const t = (document.getElementById('aiPrompt').value||'').toLowerCase();
      if(/all[-\s]?hands/.test(t)) state.type = 'All‑Hands';
      if(/\bqbr\b/.test(t)) state.type = 'QBR';
      if(/town ?hall/.test(t)) state.type = 'Town Hall';
      if(/launch/.test(t)) state.type = 'Product Launch';
      if(/training/.test(t)) state.type = 'Training';
      const m = t.match(/(\d{1,2})(?:[:\.](\d{2}))?\s?(am|pm)/);
      if(m){ let h=Number(m[1]); if(m[3]==='pm'&&h<12)h+=12; if(m[3]==='am'&&h===12)h=0; const mm=m[2]||'00'; state.start=`${String(h).padStart(2,'0')}:${mm}`; }
      if(/\bto\b|–|-/.test(t)){
        const m2 = t.match(/\b(\d{1,2})(?:[:\.](\d{2}))?\s?(am|pm)\s?(?:to|–|-)\s?(\d{1,2})(?:[:\.](\d{2}))?\s?(am|pm)/);
        if(m2){ let h=Number(m2[4]); if(m2[6]==='pm'&&h<12)h+=12; if(m2[6]==='am'&&h===12)h=0; const mm=m2[5]||'00'; state.end=`${String(h).padStart(2,'0')}:${mm}`; }
      }
      if(/zoom/.test(t)) state.platform='Zoom'; else if(/teams/.test(t)) state.platform='Teams'; else if(/webex/.test(t)) state.platform='Webex';
      const room = (t.match(/in ([a-z0-9\- ]+auditorium|room [a-z0-9\-]+)/) || [,''])[1]; if(room) state.room = room.replace(/^in /,'');
      if(/record/.test(t)) state.options = [...new Set([...(state.options||[]),'Recording'])];
      if(/asl|interpret/.test(t)) state.options = [...new Set([...(state.options||[]),'ASL / Interpretation'])];
      render(); toast('Wizard prefilled');
    }

    // Wire controls
    document.getElementById('backBtn').onclick = ()=>{ if (idx>0){ idx--; render(); } };
    document.getElementById('reviewBtn').onclick = review;
    document.getElementById('cancelConfirm').onclick = ()=>document.getElementById('confirmModal').style.display='none';
    document.getElementById('finalSubmit').onclick = finalSubmit;
    document.getElementById('aiAssist').onclick = aiAssist;
    document.getElementById('editBtn')?.addEventListener('click', ()=>{ document.getElementById('confirmModal').style.display='none'; });

    // init straight to Step 1 (Event Type)
    (function init(){ render(); })();

    // -----------------------
    // Minimal Dev Test Suite
    // -----------------------
    (function runTests(){
      const results = [];
      const pass = (name)=>{ console.log('%c[TEST PASS] '+name,'color:#59d18c'); results.push({name,ok:true}); };
      const fail = (name,got,exp)=>{ console.error('[TEST FAIL] '+name,{got,expected:exp}); results.push({name,ok:false,got,exp}); };
      const eq = (a,b)=> JSON.stringify(a)===JSON.stringify(b);

      // 1) mapOptions basic
      try { const got = mapOptions(['Recording','Live Stream']); const exp = ['record','livestream']; eq(got,exp)?pass('mapOptions basic'):fail('mapOptions basic',got,exp); } catch(e){ fail('mapOptions threw',String(e)); }

      // 2) inferName
      try { const got = inferName({type:'All‑Hands',date:'2025-10-03'}); const exp = 'All‑Hands 2025-10-03'; eq(got,exp)?pass('inferName basic'):fail('inferName basic',got,exp); } catch(e){ fail('inferName threw',String(e)); }

      // 3) review payload keys (kept in hidden JSON)
      try {
        Object.assign(state,{event_name:'All Hands',type:'QBR',date:'2025-11-01',start:'10:00',end:'11:00',room:'SF‑Auditorium',platform:'Zoom',poc_name:'Owner',poc:'owner@co.com',options:['Recording'],notes:'test'});
        review();
        const payload = JSON.parse(document.getElementById('confirmJson').textContent||'{}');
        const keys = ['intent','name','type','date','time','end','room','platform','poc','production_opts','notes'];
        const got = keys.every(k=>k in payload);
        got?pass('review payload keys'):fail('review payload keys',payload,keys);
        document.getElementById('cancelConfirm').click();
      } catch(e){ fail('review threw',String(e)); }

      // 4) aiAssist heuristic non‑throwing
      try { document.getElementById('aiPrompt').value = 'All-hands next Fri 10am to 11am in SF Auditorium via Zoom, record'; aiAssist(); pass('aiAssist callable'); } catch(e){ fail('aiAssist threw',String(e)); }

      // 5) dynamic steps insertion (options -> guests/slides)
      try {
        state.options = ['Special Guests / Executives','PPT / Presentation'];
        const lenWith = computeSteps().length;
        state.options = [];
        const lenWithout = computeSteps().length;
        if (lenWith>lenWithout) pass('dynamic steps added'); else fail('dynamic steps added',lenWith,lenWithout);
      } catch(e){ fail('dynamic steps threw',String(e)); }

      // 6) initial render shows Event Type (no Start screen)
      try {
        const msg = document.getElementById('message').textContent;
        if (/What type of event/.test(msg)) pass('initial step is Event Type'); else fail('initial step is Event Type', msg, 'What type of event…');
      } catch(e){ fail('initial step threw',String(e)); }

      // 7) Tooltip helper returns text for Registration
      try {
        const tip = getTip('options','Registration');
        if (typeof tip === 'string' && tip.length>0) pass('tooltip for Registration'); else fail('tooltip for Registration', tip, 'non-empty string');
      } catch(e){ fail('tooltip threw',String(e)); }

      // Summary prints in console only
    })();
  </script>
</body>
</html>
